apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: nesventory-aws

namespace: nesventory

resources:
  - ../../base
  - service-account.yaml

# AWS-specific patches
patches:
  # Configure deployment for AWS with S3 storage
  - target:
      kind: Deployment
      name: nesventory
    patch: |
      - op: replace
        path: /spec/replicas
        value: 3
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "512Mi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "250m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: "1Gi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: "1000m"
      - op: add
        path: /spec/template/spec/serviceAccountName
        value: nesventory

  # Configure PostgreSQL for AWS RDS (remove StatefulSet)
  - target:
      kind: StatefulSet
      name: postgres-ha
    patch: |
      $patch: delete

  # Remove PostgreSQL PDB since we're using RDS
  - target:
      kind: PodDisruptionBudget
      name: postgres-pdb
    patch: |
      $patch: delete

  # AWS HPA settings
  - target:
      kind: HorizontalPodAutoscaler
      name: nesventory-hpa
    patch: |
      - op: replace
        path: /spec/minReplicas
        value: 3
      - op: replace
        path: /spec/maxReplicas
        value: 20

  # Update ingress for AWS ALB
  - target:
      kind: Ingress
      name: nesventory-ingress
    patch: |
      - op: replace
        path: /metadata/annotations
        value:
          kubernetes.io/ingress.class: alb
          alb.ingress.kubernetes.io/scheme: internet-facing
          alb.ingress.kubernetes.io/target-type: ip
          alb.ingress.kubernetes.io/healthcheck-path: /api/health
          alb.ingress.kubernetes.io/listen-ports: '[{"HTTPS":443}]'
          alb.ingress.kubernetes.io/ssl-redirect: "443"

# ConfigMap patches for S3 storage
configMapGenerator:
  - name: nesventory-config
    behavior: merge
    literals:
      # Storage configuration
      - STORAGE_TYPE=s3
      # S3 settings will be provided via secrets or environment
      # DB settings for RDS
      # IMPORTANT: Replace <your-rds-endpoint> with actual value from Terraform output:
      #   terraform output rds_address
      - DB_HOST=<your-rds-endpoint>.us-east-1.rds.amazonaws.com
      - DB_PORT=5432
      - DB_NAME=nesventory
      - DB_USER=nesventory

# Secret patches for AWS
secretGenerator:
  - name: nesventory-secrets
    behavior: merge
    literals:
      # S3 bucket name
      # IMPORTANT: Replace <your-s3-bucket> with actual value from Terraform output:
      #   terraform output s3_bucket_name
      - S3_BUCKET_NAME=<your-s3-bucket>
      - S3_REGION=us-east-1
      # AWS credentials are provided via IRSA (IAM Role for Service Accounts)
      # so we don't need to set S3_ACCESS_KEY_ID or S3_SECRET_ACCESS_KEY

labels:
  - pairs:
      environment: aws
      cloud-provider: aws
