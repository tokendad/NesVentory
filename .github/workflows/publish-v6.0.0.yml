name: Publish Release v6.0.0
# Manual workflow to immediately publish the v6.0.0 release
# This can be triggered from the Actions tab

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "yes" to confirm publishing v6.0.0'
        required: true
        default: ''

jobs:
  publish-release:
    name: Publish GitHub Release v6.0.0
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "yes" ]; then
            echo "‚ùå Confirmation not provided. Please type 'yes' to confirm."
            exit 1
          fi
          echo "‚úì Confirmation received"
          
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0
          
      - name: Check if release already exists
        id: check_release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
        run: |
          if gh release view v6.0.0 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Release v6.0.0 already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚úì Release v6.0.0 does not exist yet"
          fi
          
      - name: Check for release materials
        run: |
          if [ ! -f "RELEASE_v6.0.0.md" ]; then
            echo "‚ùå RELEASE_v6.0.0.md not found"
            exit 1
          fi
          echo "‚úì Found RELEASE_v6.0.0.md"
          
          if [ ! -f "VERSION" ]; then
            echo "‚ùå VERSION file not found"
            exit 1
          fi
          echo "‚úì Found VERSION file"
          
          VERSION=$(cat VERSION | tr -d '[:space:]')
          echo "Current VERSION: $VERSION"
          
      - name: Create and push tag
        if: steps.check_release.outputs.exists != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if tag already exists locally
          if git rev-parse v6.0.0 >/dev/null 2>&1; then
            echo "‚úì Tag v6.0.0 already exists locally"
          else
            echo "Creating tag v6.0.0..."
            git tag -a v6.0.0 -F RELEASE_v6.0.0.md
            echo "‚úì Created tag v6.0.0"
          fi
          
          # Push the tag
          echo "Pushing tag to GitHub..."
          git push origin v6.0.0 || echo "Tag may already exist on remote"
          echo "‚úì Tag pushed"
          
      - name: Create GitHub Release
        if: steps.check_release.outputs.exists != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v6.0.0
          name: "NesVentory v6.0.0 - Major Release"
          body_path: RELEASE_v6.0.0.md
          draft: false
          prerelease: false
          make_latest: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Release created
        if: steps.check_release.outputs.exists != 'true'
        run: |
          echo "=================================================="
          echo "‚úÖ Release v6.0.0 published successfully!"
          echo "=================================================="
          echo ""
          echo "üì¶ View the release:"
          echo "   https://github.com/${{ github.repository }}/releases/tag/v6.0.0"
          echo ""
          echo "üêã Next steps:"
          echo "   1. Trigger Docker Hub publish workflow:"
          echo "      https://github.com/${{ github.repository }}/actions/workflows/docker-publish.yml"
          echo ""
          echo "   2. Verify the release page has all information"
          echo ""
          echo "   3. Announce the release to users"
          echo ""
          
      - name: Release already exists
        if: steps.check_release.outputs.exists == 'true'
        run: |
          echo "=================================================="
          echo "‚ÑπÔ∏è  Release v6.0.0 already exists"
          echo "=================================================="
          echo ""
          echo "View existing release:"
          echo "   https://github.com/${{ github.repository }}/releases/tag/v6.0.0"
          echo ""
          echo "If you need to update it, please delete the existing release first."
          echo ""
