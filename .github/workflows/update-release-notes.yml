name: Update Release Notes

on:
  pull_request:
    types: [closed]
    branches:
      - main

permissions:
  contents: write

jobs:
  update-release-notes:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Get current version
        id: version
        run: |
          version=$(cat VERSION | tr -d '\n')
          echo "version=$version" >> $GITHUB_OUTPUT
          
          # Determine version type (major, minor, patch)
          IFS='.' read -r major minor patch <<< "$version"
          echo "major=$major" >> $GITHUB_OUTPUT
          echo "minor=$minor" >> $GITHUB_OUTPUT
          echo "patch=$patch" >> $GITHUB_OUTPUT

      - name: Get last tag
        id: last_tag
        run: |
          git fetch --tags
          tag=$(git tag --sort=-creatordate | head -n1)
          echo "last_tag=$tag" >> $GITHUB_OUTPUT

      - name: Generate release notes content
        id: notes
        run: |
          version="${{ steps.version.outputs.version }}"
          major="${{ steps.version.outputs.major }}"
          minor="${{ steps.version.outputs.minor }}"
          patch="${{ steps.version.outputs.patch }}"
          last_tag="${{ steps.last_tag.outputs.last_tag }}"
          
          # Determine log range
          if [ -z "$last_tag" ]; then
            log_range=""
          else
            log_range="$last_tag..HEAD"
          fi
          
          # Start building release notes
          {
            echo "# NesVentory v${version} Release Notes"
            echo ""
            echo "## Overview"
            echo ""
            echo "Version ${version} of NesVentory."
            echo ""
          } > RELEASE_NOTES.md
          
          # Collect commits by type
          features=$(git log $log_range --pretty=format:"%s" 2>/dev/null | grep -E '^feat(\(.+\))?:' | sed 's/^feat(\([^)]*\)): /- **\1**: /' | sed 's/^feat: /- /' || true)
          fixes=$(git log $log_range --pretty=format:"%s" 2>/dev/null | grep -E '^fix(\(.+\))?:' | sed 's/^fix(\([^)]*\)): /- **\1**: /' | sed 's/^fix: /- /' || true)
          breaking=$(git log $log_range --pretty=format:"%s" 2>/dev/null | grep -iE '^(breaking change|BREAKING CHANGE)' || true)
          deps=$(git log $log_range --pretty=format:"%s" 2>/dev/null | grep -iE '^(chore\(deps\)|build\(deps\)|Bump .+ from .+ to)' | sed 's/^chore(deps): //' | sed 's/^build(deps): //' | sed 's/^/- /' || true)
          security=$(git log $log_range --pretty=format:"%s" 2>/dev/null | grep -iE '^(security|fix\(security\))' | sed 's/^security: //' | sed 's/^fix(security): //' | sed 's/^/- /' || true)
          
          # Add New Features section
          if [ -n "$features" ]; then
            {
              echo "## New Features"
              echo ""
              echo "$features"
              echo ""
            } >> RELEASE_NOTES.md
          fi
          
          # Add Bug Fixes section
          if [ -n "$fixes" ]; then
            {
              echo "## Bug Fixes"
              echo ""
              echo "$fixes"
              echo ""
            } >> RELEASE_NOTES.md
          fi
          
          # Add Breaking Changes section
          if [ -n "$breaking" ]; then
            {
              echo "## Breaking Changes"
              echo ""
              echo "$breaking" | sed 's/^/- /'
              echo ""
            } >> RELEASE_NOTES.md
          else
            {
              echo "## Breaking Changes"
              echo ""
              echo "None"
              echo ""
            } >> RELEASE_NOTES.md
          fi
          
          # Add Dependency Updates section
          if [ -n "$deps" ]; then
            {
              echo "## Dependency Updates"
              echo ""
              echo "$deps"
              echo ""
            } >> RELEASE_NOTES.md
          fi
          
          # Add Security Updates section
          if [ -n "$security" ]; then
            {
              echo "## Security Updates"
              echo ""
              echo "$security"
              echo ""
            } >> RELEASE_NOTES.md
          fi
          
          # Add footer
          {
            echo "---"
            echo ""
            echo "See complete PRs: https://github.com/${{ github.repository }}/pulls?q=is%3Apr+is%3Aclosed"
          } >> RELEASE_NOTES.md
          
          echo "Release notes generated for v${version}"

      - name: Commit and push release notes to a new branch
        id: commit_push
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          # Check if RELEASE_NOTES.md has changes
          if git diff --quiet RELEASE_NOTES.md; then
            echo "No changes to RELEASE_NOTES.md"
            echo "CHANGED=false" >> $GITHUB_OUTPUT
          else
            BRANCH_NAME="update-release-notes-v${{ steps.version.outputs.version }}-$(date +%s)"
            git checkout -b "$BRANCH_NAME"
            git add RELEASE_NOTES.md
            git commit -m "docs: update RELEASE_NOTES.md for v${{ steps.version.outputs.version }}"
            git push --set-upstream origin "$BRANCH_NAME"
            echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
            echo "CHANGED=true" >> $GITHUB_OUTPUT
          fi

      - name: Create pull request for release notes
        if: steps.commit_push.outputs.CHANGED == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.commit_push.outputs.branch }}
          title: "docs: Update RELEASE_NOTES.md for v${{ steps.version.outputs.version }}"
          body: |
            Automated release notes update for v${{ steps.version.outputs.version }}

            This PR was created by the Update Release Notes workflow.
