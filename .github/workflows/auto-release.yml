name: Automated Release Creation

on:
  push:
    branches:
      - main
    paths:
      - VERSION

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get current version
        id: get_version
        run: |
          version=$(cat VERSION | tr -d '\n')
          echo "version=$version" >> $GITHUB_OUTPUT
          
          # Parse version components
          IFS='.' read -r major minor patch <<< "$version"
          echo "major=$major" >> $GITHUB_OUTPUT
          echo "minor=$minor" >> $GITHUB_OUTPUT
          echo "patch=$patch" >> $GITHUB_OUTPUT

      - name: Fetch tags
        run: |
          git fetch --tags

      - name: Get last tag
        id: last_tag
        run: |
          tag=$(git tag --sort=-creatordate | head -n1)
          echo "last_tag=$tag" >> $GITHUB_OUTPUT
          
          # Determine if this is a major version bump
          if [ -n "$tag" ]; then
            last_major=$(echo "$tag" | sed 's/^v//' | cut -d. -f1)
            current_major="${{ steps.get_version.outputs.major }}"
            if [ "$current_major" -gt "$last_major" ]; then
              echo "is_major=true" >> $GITHUB_OUTPUT
            else
              echo "is_major=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "is_major=true" >> $GITHUB_OUTPUT
          fi

      - name: Generate release notes
        id: notes
        run: |
          version="${{ steps.get_version.outputs.version }}"
          is_major="${{ steps.last_tag.outputs.is_major }}"
          last_tag="${{ steps.last_tag.outputs.last_tag }}"
          
          # Determine log range
          if [ -z "$last_tag" ]; then
            log_range=""
          else
            log_range="$last_tag..HEAD"
          fi
          
          # Start building release notes
          {
            echo "# NesVentory v${version} Release Notes"
            echo ""
            echo "## Overview"
            echo ""
            echo "Version ${version} of NesVentory."
            echo ""
          } > release_notes.txt
          
          # Collect commits by type
          features=$(git log $log_range --pretty=format:"%s" 2>/dev/null | grep -E '^feat(\(.+\))?:' | sed 's/^feat(\([^)]*\)): /- **\1**: /' | sed 's/^feat: /- /' || true)
          fixes=$(git log $log_range --pretty=format:"%s" 2>/dev/null | grep -E '^fix(\(.+\))?:' | sed 's/^fix(\([^)]*\)): /- **\1**: /' | sed 's/^fix: /- /' || true)
          breaking=$(git log $log_range --pretty=format:"%s" 2>/dev/null | grep -iE '^(breaking change|BREAKING CHANGE)' || true)
          deps=$(git log $log_range --pretty=format:"%s" 2>/dev/null | grep -iE '^(chore\(deps\)|build\(deps\)|Bump .+ from .+ to)' | head -20 || true)
          security=$(git log $log_range --pretty=format:"%s" 2>/dev/null | grep -iE '^(security|fix\(security\))' || true)
          
          # Add New Features section
          if [ -n "$features" ]; then
            {
              echo "## New Features"
              echo ""
              echo "$features"
              echo ""
            } >> release_notes.txt
          fi
          
          # Add Bug Fixes section
          if [ -n "$fixes" ]; then
            {
              echo "## Bug Fixes"
              echo ""
              echo "$fixes"
              echo ""
            } >> release_notes.txt
          fi
          
          # Add Breaking Changes section
          if [ -n "$breaking" ]; then
            {
              echo "## Breaking Changes"
              echo ""
              echo "$breaking" | sed 's/^/- /'
              echo ""
            } >> release_notes.txt
          else
            {
              echo "## Breaking Changes"
              echo ""
              echo "None"
              echo ""
            } >> release_notes.txt
          fi
          
          # Add Dependency Updates section
          if [ -n "$deps" ]; then
            {
              echo "## Dependency Updates"
              echo ""
              echo "$deps" | sed 's/^/- /'
              echo ""
            } >> release_notes.txt
          fi
          
          # Add Security Updates section
          if [ -n "$security" ]; then
            {
              echo "## Security Updates"
              echo ""
              echo "$security" | sed 's/^/- /'
              echo ""
            } >> release_notes.txt
          fi
          
          # Only include full feature list for major releases
          if [ "$is_major" = "true" ]; then
            {
              echo "## Current Features"
              echo ""
              echo "### AI-Powered Inventory Management"
              echo "- **AI Photo Detection** - Scan any room with your camera and let AI detect items automatically using Google Gemini"
              echo "- **AI Data Tag Parsing** - Take a photo of a product's data tag/label to extract manufacturer, model, serial number, and more"
              echo "- **AI Value Estimation** - Get AI-powered estimated values for your items with source tracking"
              echo ""
              echo "### Logo & Branding Support"
              echo "- Display custom logo in header and login screen"
              echo "- Configurable branding for deployments"
              echo ""
              echo "### Theme & Color Support"
              echo "- User preference settings for themes"
              echo "- Customizable color schemes"
              echo ""
              echo "### Hierarchical Location Browser"
              echo "- Interactive clickable navigation"
              echo "- Visual tree structure with expand/collapse"
              echo ""
              echo "### User Management"
              echo "- Google OAuth SSO for easy authentication"
              echo "- Admin user creation and approval workflow"
              echo "- Role-based access control (Admin, Editor, Viewer)"
              echo "- Location-based access restrictions"
              echo ""
              echo "### Bulk Operations"
              echo "- Multi-select items for bulk actions"
              echo "- Bulk delete, tag update, and location assignment"
              echo "- Left-aligned action bars for better UX"
              echo ""
              echo "### Data Import"
              echo "- Enhanced Encircle XLSX import"
              echo "- Parent/sub-location hierarchy support"
              echo "- Automatic location creation from import files"
              echo ""
              echo "### Core Features"
              echo "- ðŸ“¦ Inventory Management - Track all household items with detailed information"
              echo "- ðŸ“ Location Hierarchy - Organize items by rooms and sub-locations"
              echo "- ðŸ˜ï¸ Multi-Property Support - Manage multiple homes and multi-family properties"
              echo "- ðŸ‘¥ Landlord/Tenant Management - Track landlord and tenant info for rental properties"
              echo "- ðŸ› ï¸ Maintenance Tracking - Schedule and track recurring maintenance tasks"
              echo "- ðŸŒ International Formats - Support for 25+ locales and 20+ currencies"
              echo "- ðŸ³ Docker Ready - Easy deployment with single unified container"
              echo "- ðŸŽ¯ Pre-seeded Test Data - Start testing immediately with sample data"
              echo ""
            } >> release_notes.txt
          fi
          
          # Add footer
          {
            echo "---"
            echo ""
            echo "See complete PRs: https://github.com/${{ github.repository }}/pulls?q=is%3Apr+is%3Aclosed"
          } >> release_notes.txt
          
          echo "Release notes generated for v${version} (major=$is_major)"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          name: Version ${{ steps.get_version.outputs.version }}
          body_path: release_notes.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
